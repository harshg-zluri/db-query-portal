
> db-query-portal@1.0.0 test
> jest --coverage tests/unit/controllers/database.controller.test.ts tests/unit/services/postgres.executor.test.ts tests/unit/services/slack.service.test.ts

PASS tests/unit/services/postgres.executor.test.ts
  PostgresExecutor
    connect
      ‚úì should create client on first connect (6 ms)
      ‚úì should reuse client on subsequent connects (1 ms)
    close
      ‚úì should close client (1 ms)
      ‚úì should handle close without connect
    execute
      ‚úì should execute SELECT query and return rows (1 ms)
      ‚úì should execute UPDATE and return affected rows
      ‚úì should handle empty result
      ‚úì should allow DDL statements (warnings handled at submission) (1 ms)
      ‚úì should execute valid DELETE queries (DML)
      ‚úì should handle query error (1 ms)
      ‚úì should set search path when schema provided
      ‚úì should handle null/undefined result from driver (1 ms)
      ‚úì should handle non-Error exception
      ‚úì should handle result with missing count/length
      ‚úì should block query that exceeds row limit (35 ms)
      ‚úì should allow query with exactly MAX_ROWS (1 ms)
      ‚úì should handle malformed count result gracefully
      ‚úì should fallback to 0 rows if count query returns empty (e.g. driver weirdness)
    testConnection
      ‚úì should return true for valid connection
      ‚úì should return false for failed connection
    createPostgresExecutor
      ‚úì should create executor from connection string
      ‚úì should throw for invalid connection string (20 ms)
    constructor
      ‚úì should configure connection string with ssl by default
      ‚úì should disable ssl when explicitly set to false

  console.error
    Debug discovery error: Error: Unexpected
        at Object.<anonymous> (/Users/harshgoyal/Desktop/db-query-portal/backend/tests/unit/controllers/database.controller.test.ts:413:74)
        at /Users/harshgoyal/Desktop/db-query-portal/backend/node_modules/jest-mock/build/index.js:397:39
        at Object.<anonymous> (/Users/harshgoyal/Desktop/db-query-portal/backend/node_modules/jest-mock/build/index.js:404:13)
        at Object.mockConstructor [as json] (/Users/harshgoyal/Desktop/db-query-portal/backend/node_modules/jest-mock/build/index.js:148:19)
        at Function.json [as debugDiscovery] (/Users/harshgoyal/Desktop/db-query-portal/backend/src/controllers/database.controller.ts:182:17)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at Object.<anonymous> (/Users/harshgoyal/Desktop/db-query-portal/backend/tests/unit/controllers/database.controller.test.ts:415:13)

      182 |             res.json({ success: true, checks });
      183 |         } catch (error) {
    > 184 |             console.error('Debug discovery error:', error);
          |                     ^
      185 |             next(error);
      186 |         }
      187 |     }

      at Function.error [as debugDiscovery] (src/controllers/database.controller.ts:184:21)
      at Object.<anonymous> (tests/unit/controllers/database.controller.test.ts:415:13)

FAIL tests/unit/services/slack.service.test.ts
  ‚óè Test suite failed to run

    [96mtests/unit/services/slack.service.test.ts[0m:[93m470[0m:[93m17[0m - [91merror[0m[90m TS2353: [0mObject literal may only specify known properties, and 'expect' does not exist in type '{ success: boolean; rowCount?: number | undefined; output?: string | undefined; error?: string | undefined; isCompressed?: boolean | undefined; originalSize?: number | undefined; }'.

    [7m470[0m                 expect(mockWebClient.files.uploadV2).not.toHaveBeenCalled();
    [7m   [0m [91m                ~~~~~~[0m
    [96mtests/unit/services/slack.service.test.ts[0m:[93m470[0m:[93m24[0m - [91merror[0m[90m TS7006: [0mParameter 'mockWebClient' implicitly has an 'any' type.

    [7m470[0m                 expect(mockWebClient.files.uploadV2).not.toHaveBeenCalled();
    [7m   [0m [91m                       ~~~~~~~~~~~~~[0m
    [96mtests/unit/services/slack.service.test.ts[0m:[93m470[0m:[93m54[0m - [91merror[0m[90m TS2339: [0mProperty 'not' does not exist on type 'Promise<void>'.

    [7m470[0m                 expect(mockWebClient.files.uploadV2).not.toHaveBeenCalled();
    [7m   [0m [91m                                                     ~~~[0m
    [96mtests/unit/services/slack.service.test.ts[0m:[93m470[0m:[93m17[0m - [91merror[0m[90m TS1005: [0m',' expected.

    [7m470[0m                 expect(mockWebClient.files.uploadV2).not.toHaveBeenCalled();
    [7m   [0m [91m                ~~~~~~[0m
    [96mtests/unit/services/slack.service.test.ts[0m:[93m470[0m:[93m37[0m - [91merror[0m[90m TS1005: [0m',' expected.

    [7m470[0m                 expect(mockWebClient.files.uploadV2).not.toHaveBeenCalled();
    [7m   [0m [91m                                    ~[0m
    [96mtests/unit/services/slack.service.test.ts[0m:[93m470[0m:[93m52[0m - [91merror[0m[90m TS1005: [0m',' expected.

    [7m470[0m                 expect(mockWebClient.files.uploadV2).not.toHaveBeenCalled();
    [7m   [0m [91m                                                   ~[0m

PASS tests/unit/controllers/database.controller.test.ts
  DatabaseController
    getTypes
      ‚úì should return database types (7 ms)
      ‚úì should handle errors
    getInstances
      ‚úì should handle errors (1 ms)
      ‚úì should list all instances
      ‚úì should filter by type
    getDatabases
      ‚úì should list databases for instance (1 ms)
      ‚úì should throw NotFoundError if instance missing
      ‚úì should use dynamic discovery for PostgreSQL (1 ms)
      ‚úì should use dynamic discovery for MongoDB
      ‚úì should fallback to static list if config missing (PG)
      ‚úì should fallback to static list if config missing (Mongo)
    getInstanceById
      ‚úì should return instance if found
      ‚úì should throw NotFoundError if not found (1 ms)
    getDatabases - discovery failure fallback
      ‚úì should fallback to static list when discovery fails with error
      ‚úì should fallback when discovery returns empty array (PG)
      ‚úì should fallback when discovery returns empty array (Mongo)
      ‚úì should use safety fallback if discovery fails and instance has no databases (1 ms)
      ‚úì should use safety fallback for MongoDB when discovery fails
      ‚úì should handle non-Error exception during discovery
    debugDiscovery
      ‚úì should return success for both postgres and mongo
      ‚úì should handle postgres discovery error
      ‚úì should handle non-Error exceptions for debug discovery (1 ms)
      ‚úì should handle mongo discovery error
      ‚úì should skip postgres when URL not set
      ‚úì should skip mongo when URL not set
      ‚úì should call next with error on unexpected failure (36 ms)

-------------------------|---------|----------|---------|---------|-------------------
File                     | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------------|---------|----------|---------|---------|-------------------
All files                |   85.05 |    78.15 |   53.84 |   86.17 |                   
 config                  |    62.5 |    64.81 |       0 |    62.5 |                   
  environment.ts         |    62.5 |    64.81 |       0 |    62.5 | 80-82             
 controllers             |     100 |      100 |     100 |     100 |                   
  database.controller.ts |     100 |      100 |     100 |     100 |                   
 entities                |   76.47 |      100 |       0 |   91.66 |                   
  DatabaseInstance.ts    |   76.47 |      100 |       0 |   91.66 | 13                
 models                  |      15 |        0 |       0 |      15 |                   
  DatabaseInstance.ts    |      15 |        0 |       0 |      15 | 10-57             
 services                |     100 |      100 |     100 |     100 |                   
  postgres.executor.ts   |     100 |      100 |     100 |     100 |                   
 utils                   |   72.22 |    16.66 |   28.57 |   72.22 |                   
  errors.ts              |   72.22 |    16.66 |   28.57 |   72.22 | 26,32,38,50,56    
-------------------------|---------|----------|---------|---------|-------------------
Jest: "global" coverage threshold for functions (60%) not met: 53.84%
Test Suites: 1 failed, 2 passed, 3 total
Tests:       50 passed, 50 total
Snapshots:   0 total
Time:        2.848 s, estimated 3 s
Ran all test suites matching /tests\/unit\/controllers\/database.controller.test.ts|tests\/unit\/services\/postgres.executor.test.ts|tests\/unit\/services\/slack.service.test.ts/i.
