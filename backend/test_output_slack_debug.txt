
> db-query-portal@1.0.0 test
> jest --coverage tests/unit/services/slack.service.test.ts

  console.log
    DEBUG: Inside uploadResultFile

      at Function.log [as uploadResultFile] (src/services/slack.service.ts:136:17)

  console.log
    DEBUG: Inside uploadResultFile

      at Function.log [as uploadResultFile] (src/services/slack.service.ts:136:17)

  console.log
    DEBUG: Inside uploadResultFile

      at Function.log [as uploadResultFile] (src/services/slack.service.ts:136:17)

  console.log
    DEBUG: Inside uploadResultFile

      at Function.log [as uploadResultFile] (src/services/slack.service.ts:136:17)

PASS tests/unit/services/slack.service.test.ts
  SlackService
    initialize
      ✓ should warn and disable if token is missing (1 ms)
      ✓ should initialize client if token is present
    Notification Methods
      notifyNewRequest
        ✓ should send notification to channel with correct blocks (16 ms)
        ✓ should include app link for approval in new request notification
        ✓ should skip if approval channel not configured
        ✓ should handle errors gracefully
        ✓ should skip if service disabled
        ✓ should handle non-Error exceptions
        ✓ should handle missing databaseName
        ✓ should handle missing comments
        ✓ should truncate long query in new request
        ✓ should truncate long script in new request
        ✓ should silently skip if client is not valid in new request
        ✓ should handle compressed result without original size
      notifyRequesterApproved
        ✓ should send DM to requester (1 ms)
        ✓ should log warning if user not found
        ✓ should include error details in DM if execution failed
        ✓ should include retry link in DM if execution failed
        ✓ should skip if service disabled (1 ms)
        ✓ should include short output in DM
        ✓ should handle compressed execution result
        ✓ should handle compressed execution result without originalSize
        ✓ should handle errors gracefully
        ✓ should handle non-Error exceptions (1 ms)
        ✓ should silently skip if client is not valid in approval
      notifyChannelExecutionResult
        ✓ should send execution result to channel
        ✓ should include error details if execution failed
        ✓ should include output preview if successful and output exists
        ✓ should skip if no channel
        ✓ should skip if service disabled
        ✓ should handle errors gracefully
        ✓ should handle non-Error exceptions
        ✓ should upload file for large outputs (> 2500 chars) (16 ms)
        ✓ should NOT upload file for compressed results
        ✓ should handle file upload errors gracefully
        ✓ should show compressed result message in channel blocks
        ✓ should show "See attached file" message for large uncompressed output (1 ms)
        ✓ should handle compressed result without original size
      notifyRequesterRejected
        ✓ should send rejection DM
        ✓ should include app link in rejection DM
        ✓ should skip if service disabled (1 ms)
        ✓ should log warning if user not found
        ✓ should handle errors gracefully
        ✓ should handle non-Error exceptions
        ✓ should send rejection without reason
        ✓ should truncate long query in rejection
        ✓ should truncate long script in rejection (1 ms)
        ✓ should handle short script in rejection
        ✓ should handle both query and script missing in rejection
        ✓ should handle both query and script missing in rejection
        ✓ should silently skip if client is not valid in rejection
    helper methods (lookupSlackUserId)
      ✓ should return null on lookup error (1 ms)
      ✓ should handle non-Error exceptions in lookup
      ✓ should return null if client is null
    block builders
      ✓ should truncate long output in approval result
      ✓ should handle both query and script missing in new request logic
      ✓ should handle script content in preview if query is missing (1 ms)
    sendSlackNotification wrapper
      ✓ should route REQUEST_SUBMITTED
      ✓ should route REQUEST_APPROVED with execution results
      ✓ should route EXECUTION_SUCCESS
      ✓ should route REQUEST_REJECTED
      ✓ should catch global errors
      ✓ should handle non-Error catch in global wrapper

------------------|---------|----------|---------|---------|-------------------
File              | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
------------------|---------|----------|---------|---------|-------------------
All files         |   99.25 |    97.45 |     100 |     100 |                   
 slack.service.ts |   99.25 |    97.45 |     100 |     100 | 135-160,564       
------------------|---------|----------|---------|---------|-------------------
Test Suites: 1 passed, 1 total
Tests:       63 passed, 63 total
Snapshots:   0 total
Time:        2.059 s, estimated 3 s
Ran all test suites matching /tests\/unit\/services\/slack.service.test.ts/i.
